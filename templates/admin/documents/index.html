{% extends "layout.html" %}

{% block content %}
<div class="max-w-[1400px] mx-auto">
    <div class="flex justify-between items-end mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Архив документов</h2>
            <p class="text-sm text-gray-500">Управление базой достижений</p>
        </div>
    </div>

    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-8">
        <form action="/admin/documents" method="GET" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end" x-data="autocomplete('/admin/api/documents/search')">

            <div class="md:col-span-3 relative">
                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1 tracking-wide">Поиск</label>
                <div class="relative">
                    <div class="absolute left-3 top-2.5 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                    <input type="text" name="query" x-model="query" @input.debounce.300ms="fetchSuggestions" @keydown.escape="suggestions=[]" placeholder="Название..." autocomplete="off" value="{{ query or '' }}" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm h-[42px]">
                </div>
                <ul x-show="suggestions.length > 0" @click.outside="suggestions = []" class="absolute z-50 w-full bg-white border border-gray-100 rounded-xl shadow-xl mt-1 max-h-60 overflow-y-auto" style="display: none;" x-cloak>
                    <template x-for="item in suggestions"><li @click="selectItem(item.value)" class="px-4 py-2 hover:bg-indigo-50 cursor-pointer text-sm border-b last:border-0"><span x-text="item.text"></span></li></template>
                </ul>
            </div>

            <div class="md:col-span-2">
                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1 tracking-wide">Статус</label>
                <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer h-[42px]">
                    <option value="">Все статусы</option>
                    {% for s in statuses %}<option value="{{ s.value }}" {{ 'selected' if status == s.value else '' }}>{% if s.value == 'approved' %}Одобрено{% elif s.value == 'pending' %}На проверке{% elif s.value == 'rejected' %}Отклонено{% endif %}</option>{% endfor %}
                </select>
            </div>

            <div class="md:col-span-2">
                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1 tracking-wide">Вид</label>
                <select name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer h-[42px]">
                    <option value="">Все виды</option>
                    {% for c in categories %}<option value="{{ c.value }}" {{ 'selected' if category == c.value else '' }}>{{ c.value }}</option>{% endfor %}
                </select>
            </div>

            <div class="md:col-span-2">
                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1 tracking-wide">Уровень</label>
                <select name="level" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer h-[42px]">
                    <option value="">Все уровни</option>
                    {% for l in levels %}<option value="{{ l.value }}" {{ 'selected' if level == l.value else '' }}>{{ l.value }}</option>{% endfor %}
                </select>
            </div>

            <div class="md:col-span-2">
                <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1 tracking-wide">Сортировка</label>
                <select name="sort_by" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-white outline-none cursor-pointer h-[42px]">
                    <option value="newest" {{ 'selected' if sort_by == 'newest' else '' }}>Сначала новые</option>
                    <option value="oldest" {{ 'selected' if sort_by == 'oldest' else '' }}>Сначала старые</option>
                    <option value="level" {{ 'selected' if sort_by == 'level' else '' }}>По значимости</option>
                    <option value="category" {{ 'selected' if sort_by == 'category' else '' }}>По виду</option>
                </select>
            </div>

            <div class="md:col-span-1 flex gap-2 justify-end w-full">
                <button type="submit" class="bg-indigo-600 text-white w-full rounded-lg font-bold text-sm hover:bg-indigo-700 shadow-sm transition-colors h-[42px] flex items-center justify-center">Найти</button>
                <a href="/admin/documents" class="bg-gray-100 text-gray-500 w-[42px] rounded-lg font-bold text-sm hover:bg-gray-200 transition-colors flex items-center justify-center border border-gray-200 h-[42px]" title="Сбросить">✕</a>
            </div>
        </form>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        {% if achievements %}
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-gray-600">
                <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-semibold border-b border-gray-100">
                    <tr><th class="px-6 py-4">Файл</th><th class="px-6 py-4">Название</th><th class="px-6 py-4">Инфо</th><th class="px-6 py-4">Статус</th><th class="px-6 py-4">Владелец</th><th class="px-6 py-4 text-right"></th></tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for item in achievements %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 w-16">
                            <button @click="$dispatch('open-preview', {src: '/static/{{ item.file_path }}', type: '{{ 'pdf' if item.file_path.endswith('.pdf') else 'image' }}'})"
                                    class="w-10 h-10 rounded bg-indigo-600 text-white hover:bg-indigo-700 transition-colors flex items-center justify-center shadow-sm">
                                ⛶
                            </button>
                        </td>
                        <td class="px-6 py-4 font-bold text-gray-800">{{ item.title }}</td>
                        <td class="px-6 py-4">{{ item.category.value }} / {{ item.level.value }}</td>
                        <td class="px-6 py-4">
                            {% if item.status.value == 'approved' %}<span class="text-green-600 font-bold bg-green-50 px-2 py-1 rounded-full text-xs">Одобрено</span>
                            {% elif item.status.value == 'rejected' %}<span class="text-red-600 font-bold bg-red-50 px-2 py-1 rounded-full text-xs">Отклонено</span>
                            {% else %}<span class="text-yellow-600 font-bold bg-yellow-50 px-2 py-1 rounded-full text-xs">На проверке</span>{% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <a href="{{ url_for('admin.users.show', id=item.user.id) }}?from=documents" class="text-indigo-600 hover:text-indigo-800 hover:underline font-medium transition-colors">
                                {{ item.user.first_name }} {{ item.user.last_name }}
                            </a>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button @click="$dispatch('confirm-delete', {url: '/admin/documents/{{ item.id }}/delete', title: 'Удалить документ?', desc: 'Файл «{{ item.title }}» будет безвозвратно удален.'})"
                                    class="text-red-500 hover:text-red-700 hover:underline font-medium transition-colors">
                                Удалить
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}<div class="p-10 text-center text-gray-500">Пусто</div>{% endif %}
    </div>

    <script>
        function autocomplete(url) {
            return {
                query: new URLSearchParams(window.location.search).get('query') || '',
                suggestions: [],
                async fetchSuggestions() {
                    if (this.query.length < 1) { this.suggestions = []; return; }
                    try { const res = await fetch(`${url}?q=${this.query}`); if(res.ok) this.suggestions = await res.json(); } catch(e) {}
                },
                selectItem(val) { this.query = val; this.suggestions = []; }
            }
        }
    </script>
</div>
{% endblock %}